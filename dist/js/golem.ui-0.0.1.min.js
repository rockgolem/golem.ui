/**
 * golem.ui v0.0.1 - 2012-12-29
 * UI widgets and event management for HTML5 games
 *
 * Copyright (c) 2012 Stephen Young <steve@rockgolem.com>
 * Licensed MIT
 */
this.Golem=this.Golem||{},function(e,t,n,r,i){"use strict";var s,o,u,a=/\s+/;s={},s.checkExists=function(t,r,i){var s,o;return s=r||e,n.isArray(t)?n.each(t,function(t){return n.each(t.split("."),function(e){s=s[e]}),o=!n.isUndefined(s),u(t,o,i),s=r||e,o},this):(n.each(t.split("."),function(e){s=s[e]}),o=!n.isUndefined(s),u(t,o,i)),o},o={},o.on=function(e,t,r){var i,s;return n.isFunction(t)&&(e=e.split(a),i=this._eventRegistry||(this._eventRegistry={}),n.each(e,function(e){s=i[e]||(i[e]=[]),s.push(t,r)})),this},o.off=function(e,t,r){var i,s,o;return i=this._eventRegistry,i&&(e||t||r?(e=e?e.split(a):n.keys(i),n.each(e,function(e){s=i[e];if(!s||!t&&!r)delete i[e];else for(o=s.length-2;o>=0;o-=2)t&&s[o]!==t||r&&s[o+1]!==r||s.splice(o,2)})):delete this._eventRegistry),this},o.emit=function(e){var t,r,i,s,o,u,f;t=this._eventRegistry;if(t){f=[],e=e.split(a);for(i=1,s=arguments.length;i<s;i++)f[i-1]=arguments[i];n.each(e,function(e){u=(t.all||[]).slice(),r=(t[e]||[]).slice();if(r.length)for(i=0,s=r.length;i<s;i+=2)r[i].apply(r[i+1]||this,f);if(u.length){o=[e].concat(f);for(i=0,s=u.length;i<s;i+=2)u[i].apply(u[i+1]||this,o)}})}return this},s.EventEmitter=o,u=function(e,t,n){!n&&!t&&console.log(e+" is undefined.")},n.extend(e.Golem,{Util:s});var f;f=function(e){Golem.Util.checkExists(["createjs.PreloadJS"]),this.p=new r.PreloadJS,this.manifest=n.isUndefined(e)?[]:e,this.head=t.getElementsByTagName("head")[0],this.body=t.body,this.loaded=!1},f.prototype.addAsset=function(e,t){var r=this.loaded;return n.isArray(e)?this.manifest=this.manifest.concat(e):this.manifest.push(e),(r||n.isFunction(t))&&this.load(t),r},f.prototype.init=function(e){this.p.onFileLoad=n.bind(this.handleFile,this),this.load(e)},f.prototype.load=function(e){var t=this.p;this.loaded=!0,t.onComplete=this.getCallback(e),t.loadManifest(this.manifest)},f.prototype.handleFile=function(e){var n=r.PreloadJS;switch(e.type){case n.CSS:this.head.appendChild(e.result);break;case n.JAVASCRIPT:t.body.appendChild(e.result);break;case n.SOUND:this.body.appendChild(e.result);break;case n.IMAGE:break;case n.JSON:break;case n.XML:}},f.prototype.getCallback=function(t){var r,i,s;return i=this.p,s=this.manifest,t=n.isFunction(t)?t:function(){},r=n.bind(function(){var i=n.all(s,function(t){var r,i;return n.last(t.src.split("."))==="js"?(r=t.id.split("."),i=e,n.each(r,function(e){i=i[e]})):i=!0,!n.isUndefined(i)});i?(this.manifest=[],t()):setTimeout(r,1)},this),r},n.extend(e.Golem,{Preload:f});var l,c;l=function(e){this.widgets=[],e=e||{},this.canvas=e.canvas||l.createCanvas(),this.options=n.extend({},e,{canvas:i}),this.prepareCanvas(),this.loadStage(),this.resizeCanvas(),this.setupTicker(e)},l.prototype.addWidget=function(e){var t=l.Widget,n,r=this.stage;return n=e instanceof t?e:t.buildWidget(e,r),this.widgets.push(n),r.addChild(n.displayObject),n},l.prototype.loadStage=function(e){var t=this.canvas;t&&(e=e||this.options.stage||new r.Stage(t)),this.stage=e},l.prototype.prepareCanvas=function(){$(this.canvas).addClass("golem-stage"),e.onresize=n.bind(this.resizeCanvas,this)},l.prototype.render=function(){this.startTicker(),this.renderWidgets()},l.prototype.renderWidgets=function(){this.repositionWidgets(),n.each(this.widgets,function(e){e.render()})},l.prototype.resizeCanvas=function(){var t,r,i,s,o,u,a,f,l,c,h,p;r=this.canvas,t=this.options,f=e.innerWidth,l=e.innerHeight,c=f/l,h=t.viewportRatio||.98,a=t.aspectRatio||8/6,c<=a?(i=f*h,s=i/a):(s=l*h,i=s*a),o=((f-i)/2).toFixed(0),u=((l-s)/2).toFixed(0),n.extend(r.style,{position:"fixed",left:o+"px",top:u+"px"}),r.setAttribute("width",i),r.setAttribute("height",s),p=this.stage,this.left=parseInt(o,10),this.top=parseInt(u,10),this.width=i,this.height=s,this.repositionWidgets()},l.prototype.repositionWidgets=function(){var e,t;e=this.left,t=this.top,n.each(this.widgets,function(r){r.reposition(e,t),n.each(r.children,function(n){n.reposition(e,t)})})},c=function(e,t){this.stage.update()},l.prototype.startTicker=function(){r.Ticker.addListener(n.bind(c,this))},l.prototype.setupTicker=function(e){var t=r.Ticker;e=n.extend({},e),t.useRAF=e.useRAF||!0,t.setFPS(e.FPS||60)},l.createCanvas=function(){var e=t.createElement("canvas");return e},n.extend(e.Golem,{UI:l});var h,p,d,v,m,g,y,b,w;h=function(e){this.stage=e},h.prototype=Object.create(Golem.Util.EventEmitter),h.buildWidget=function(e,t){var n=new E[e.type](e,t);return n},h.prototype.children=[],h.prototype.addChild=function(e){this.children.push(e)},h.prototype.getNormalizedX=function(){return h.getNormalizedPositionValue(this.optionX,this.width,$(this.stage.canvas).width(),this.offsetX)},h.prototype.getNormalizedY=function(){return h.getNormalizedPositionValue(this.optionY,this.height,$(this.stage.canvas).height(),this.offsetY)},h.getNormalizedPositionValue=function(e,t,r,i){if(n.isString(e)){i=i||0;switch(e){case"top":case"left":e=i;break;case"middle":e=(r-t)/2+i;break;case"right":case"bottom":e=r-t-i}}return parseInt(e,10)},h.prototype.render=function(){},h.prototype.setupHTML=function(e){var n,i,s,o,u;s=["golem-widget"].concat(e.classes),e.className&&s.push(e.className),n=t.createElement("div"),this.optionX=e.x,this.optionY=e.y,this.offsetX=e.offsetX,this.offsetY=e.offsetY,o=this.getNormalizedX(),u=this.getNormalizedY(),i=new r.DOMElement(n),i.x=o,i.x=u,this.x=o,this.y=u,this.isHTML=!0,this.el=n,this.displayObject=i,$(this.el).css({height:this.height,width:this.width}).addClass(s.join(" "))},h.prototype.setupSpriteSheet=function(e){n.isUndefined(e)||(this.spriteSheet=new r.SpriteSheet(e),console.log(this.spriteSheet))},h.prototype.setWidthHeight=function(){var e,t,n,r;e=this.spriteSheet,t=this.dimensions,n=e._frameWidth*t[1],r=e._frameHeight*t[0],this.width=n,this.height=r},Golem.UI.Widget=h,p=function(){this.setDimensions(1,4)},p.prototype=Object.create(h.prototype),p.prototype.list=[],p.prototype.overflow=[],p.prototype.setDimensions=function(e,t){var r,i;return i=this.lastIndex=e*t-1,r=n.compact(this.list),this.dimensions=[e,t],r.length>i?this.addToOverflow(r.splice(i)):r.length=i+1,this.list=r,this},p.prototype.addToOverflow=function(e){var t=this.overflow;n.isArray(e)?t+e:t.push(e),this.emit("overflow",e,t)},p.prototype.add=function(e,t){var r,i,s,o,u,a;s=this.lastIndex,r=this.list;if(n.isObject(t))t=this.getPosition(t);else if(n.isUndefined(t)){t=-1,u=r.length;for(o=0;o<=u;++o)if(n.isUndefined(r[o])){t=o;break}}return a={item:e,index:t,lastIndex:s},t<=s?(i=r[t],r[t]=e,n.extend(a,{type:"add",replaced:i})):n.extend(a,{type:"outOfBounds"}),this.emit(a.type,a),this},p.prototype.get=function(e){var t;return n.isObject(e)&&(e=this.getPosition(e)),t=this.list[e],t},p.prototype.getPosition=function(e){var t,r,i,s;return t=this.dimensions[1],n.isObject(e)?s=(e.row-1)*t+e.column-1:(r=this.dimensions[0],i=Math.floor(e/t)+1,s={row:i,column:e-(i-1)*t+1}),s},d=function(){},d.prototype=Object.create(h.prototype),v=function(){},v.prototype=Object.create(h.prototype),m=function(){},m.prototype=Object.create(h.prototype),b=function(e,t){this.state="off",this.index=0,this.spriteSheet=e,this.buttonList=t,this.setup()},b.prototype=Object.create(Golem.Util.EventEmitter),b.buttonStates=["on","off","disabled","mousedown","active","recharging"],b.classes=["golem-button"],b.prototype.setState=function(e,t){this.state=n.contains(b.buttonStates,e)?e:"off",this.renderSprite(),n.contains(["active","recharging"],e)&&(this.emit(e,this),this.setCountdown(e,t))},b.prototype.setIndex=function(e){this.index=e||0},b.prototype.render=function(e){var t,n,r;t=this.getSpriteData().rect,n=t.width,r=t.height,$(this.el).css({width:n.toString()+"px",height:r.toString()+"px",top:(e.row-1)*r,left:(e.column-1)*n}),this.renderSprite()},b.prototype.setup=function(){var e,i,s;e=t.createElement("div"),i=t.createElement("span"),s=new w,this.on("click",n.bind(this.onClick,this)).on("activeComplete",n.bind(this.setState,this,"recharging")).on("recharged",n.bind(this.setState,this,"on")),$(i).addClass("active-pulse"),$(e).addClass(b.classes.join(" ")).append(s.el).append(i),this.el=e,this.displayObject=new r.DOMElement(e),this.scrim=s,this.setupEvents()},b.prototype.onClick=function(e){switch(this.state){case"on":n.contains(n.pluck(this.buttonList,"state"),"active")?this.emit("waiting",this):this.setState("active");break;case"recharging":this.emit("waiting",this)}},b.prototype.setupEvents=function(){var e,t,r;e=function(e){this.emit(e.type,e)},t=this.scrim,r=["click","dblclick","mousedown","mouseup","mouseover","mouseout","mouseenter","mouseleave"].join(" "),$(this.el).on(r,n.bind(e,this)),n.each(["activeComplete","recharging","recharged"],function(r){t.on(r,n.bind(e,this,{type:r}))},this)},b.prototype.getSpriteData=function(){return this.spriteSheet._frames[this.index]},b.prototype.renderSprite=function(){var e,t,n;e=this.state,t=this.displayObject,this.setBackgroundSprite(e!=="off"),n=b.classes.slice(),n.push("golem-button-"+e),this.queued&&n.push("queued"),$(this.el).removeClass().addClass(n.join(" "))},b.prototype.setBackgroundSprite=function(e){var t,n,r,i;e?(t=this.getSpriteData(),n=t.image,r=t.rect,i={background:["url('"+n.src+"')",(-r.x).toString()+"px",(-r.y).toString()+"px","no-repeat","transparent"].join(" ")}):i={background:"none"},$(this.el).css(i)},b.prototype.setCountdown=function(e,t){this.scrim.setCountdown(e||this.state,t)},b.prototype.setActiveTime=function(e){this.scrim.setActiveTime(e||0)},b.prototype.setRechargingTime=function(e){this.scrim.setRechargingTime(e||0)},w=function(e){this.options=n.extend({size:50,backgroundColor:"#000"},e),this.buildElements(),this.remaining=-1},w.prototype=Object.create(Golem.Util.EventEmitter),w.prototype.buildElements=function(){var e,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x;g=this.options,o=this.options.size,u=Math.ceil(o*Math.sqrt(2)),v=Math.round(u/2),h=o.toString()+"px",d=u.toString()+"px",m=(-Math.round((u-o)/2)).toString()+"px",e=t.createElement("div"),a=t.createElement("div"),f=t.createElement("div"),i=t.createElement("div"),s=t.createElement("div"),x=t.createElement("p"),$(x).addClass("text").css({width:h,height:h,lineHeight:h}),l=[0,d,d,v.toString()+"px"].join(" "),c=[0,v.toString()+"px",d,0].join(" "),b={width:d,height:d,backgroundColor:g.backgroundColor,clip:"rect("+l+")"},p={width:d,height:d,top:m,left:m,clip:"rect("+l+")"},$(i).addClass("half").css(b),b.clip="rect("+c+")",$(s).addClass("half").css(b),$(a).addClass("clip").css(p).append(i),p.clip="rect("+c+")",$(f).addClass("clip").css(p).append(s),$(e).addClass("golem-scrim").css({width:h,height:h}).append(a).append(f).append(x),this.el=e,this.text=x,y=r.DOMElement,w=new y(i),E=new y(s),S=[w,E],n.each(S,function(e){e.regX=v,e.regY=v,e.x=v,e.y=v,e.rotation=0}),this.displayObjects=S},w.prototype.rotate=function(e){var t,n;n=e>=180,t=this.displayObjects,t[0].rotation=n?180.001:e,t[1].rotation=n?-(180.001-e):0},w.prototype.setActiveTime=function(e){this.activeTime=e*1e3},w.prototype.setRechargingTime=function(e){this.rechargingTime=e*1e3},w.prototype.setCountdown=function(e,t){this.state=e,this.time=this[e+"Time"],this.remaining=n.isNumber(t)?t*1e3:this.time,this.lastTick=(new Date).getTime()},w.prototype.tick=function(){var e,t,n,r;e=this.remaining,e>0?(n=(new Date).getTime(),t=n-this.lastTick,e=Math.max(e-t,0),this.state==="recharging"&&(r=360-e/this.time*360,this.rotate(parseFloat(r.toFixed(3))),this.text.textContent=(e/1e3).toFixed(1)),this.lastTick=n,this.remaining=e):parseInt(e,10)===0&&(this.remaining=-1,this.emit(this.state==="recharging"?"recharged":"activeComplete"))},y=function(e,t){h.call(this,t),e=n.extend({classes:["golem-container","golem-button-bar"]},e),this.parent=$(e.parent||"body"),this.buttons=[],this.queuedButton=null,this.setDimensions(e.rows||1,e.columns||4),this.setupSpriteSheet(e.spriteSheet),this.setupButtons(e.buttons),this.setWidthHeight(),this.setupHTML(e),this.setupFillBar()},y.prototype=Object.create(p.prototype),y.prototype.setupButtons=function(e){var t,i,s,o,u,a,f,l,c,h;f=this.stage,i=this.list,h=f.addChild,t=i.length,u=this.spriteSheet,e=e||[],c=[];for(s=0;s<t;s++)n.isUndefined(i[s])&&(o=new b(u,i),this.add(o,s),l=o.scrim,h.apply(f,[o.displayObject].concat(l.displayObjects)),a=e[s],a&&this.updateButton(s,a),c.push(l),o.on("waiting",n.bind(this.updateQueue,this)).on("activeComplete",n.bind(this.deQueue,this)).on("recharged",n.bind(this.deQueueIfMatching,this,o)).on("active",n.bind(function(e){var t=e.scrim;this.dumpQueue.apply(this,Array.prototype.slice(arguments,0)),t.activeTime>0&&this.fillBar.setTargetValue(100,t.activeTime)},this)));r.Ticker.addListener(n.bind(n.each,this,c,function(e){e.tick()}))},y.prototype.setupFillBar=function(){var e,t;e=h.buildWidget({type:"FillBar",width:this.width/2,targetValue:0,x:this.optionX,y:this.optionY,offsetY:this.height+20},this.stage),t=e.container,t.alpha=0,this.fillBar=e,this.stage.addChild(t),this.addChild(e)},y.prototype.updateQueue=function(e){var t=this.queuedButton;n.isNull(t)||(t.queued=!1,t.renderSprite()),this.queuedButton=e,e.queued=!0,e.renderSprite()},y.prototype.deQueue=function(){var e=this.queuedButton;n.isNull(e)||(this.queuedButton=null,e.queued=!1,e.emit("click"))},y.prototype.deQueueIfMatching=function(e){var t=this.queuedButton;t===e&&(this.queuedButton=null,e.queued=!1,e.emit("click"))},y.prototype.dumpQueue=function(){var e;e=this.queuedButton,n.isNull(e)||(this.queuedButton=null,e.queued=!1,e.renderSprite())},y.prototype.updateButton=function(e,t){var r=this.get(e);t=n.extend({index:r.index,activeTime:r.activeTime,rechargingTime:r.rechargingTime,state:r.state,activeTimeRemaining:r.activeTimeRemaining,rechargeTimeRemaining:r.rechargeTimeRemaining},t),r.setIndex(t.index),r.setActiveTime(t.activeTime),r.setRechargingTime(t.rechargingTime),r.setState(t.state,t.activeTimeRemaining||t.rechargeTimeRemaining)},y.prototype.render=function(){var e,t;e=$(this.el),t=this.spriteSheet,n.each(this.list,function(t,n){t.render(this.getPosition(n)),e.append(t.el)},this),this.parent.append(e)},y.prototype.reposition=function(e,t){var n=this.displayObject;n.x=this.getNormalizedX()+e,n.y=this.getNormalizedY()+t},g=function(e,t){h.call(this,t),e=n.extend({x:"middle",y:"middle",width:100,height:20,max:100,value:0,targetValue:100,duration:2,borderColor:"#ccc",fillColor:"rgb(245, 245, 220)"},e),this.drawShapes(e),this.max=e.max,this.value=e.value,this.targetValue=e.targetValue,this.duration=e.duration*1e3,this.lastTick=(new Date).getTime(),r.Ticker.addListener(n.bind(this.tick,this))},g.prototype=Object.create(d.prototype),g.prototype.reposition=function(){var e;e=this.container,e.x=this.getNormalizedX(),e.y=this.getNormalizedY()},g.prototype.drawShapes=function(e){var t,n,i;t=new r.Container,n=new r.Shape,this.optionX=e.x,this.optionY=e.y,this.offsetX=e.offsetX,this.offsetY=e.offsetY,this.width=e.width,this.height=e.height,this.fillColor=e.fillColor,this.borderColor=e.borderColor,this.height=e.height,n.graphics.beginFill(e.borderColor).drawRoundRect(0,0,e.width,e.height,4),i=new r.Shape,t.addChild(n),t.addChild(i),this.container=t,this.fill=i},g.prototype.drawFillPosition=function(){this.fill.graphics.clear().beginFill(this.fillColor).drawRoundRect(2,2,(this.width-4)/this.max*this.value,this.height-4,2)},g.prototype.render=function(){this.stage.addChild(this.container)},g.prototype.tick=function(){var e,t,n,r,i;e=this.value,t=this.targetValue,i=this.duration,n=(new Date).getTime(),r=n-this.lastTick,e>t?(this.value=Math.max(t,e-r/i*this.max),this.drawFillPosition()):e<t&&(this.value=Math.min(t,e+r/i*this.max),this.drawFillPosition()),this.lastTick=n},g.prototype.setTargetValue=function(e,t){var n=this.container;this.lastTick=(new Date).getTime(),this.targetValue=e,e!==this.value&&(this.duration=t||1e3,r.Tween.get(n).to({alpha:1}))};var E={Collection:p,ButtonBar:y,Data:d,FillBar:g,Menu:v,Utility:m}}(this,document,_,createjs);